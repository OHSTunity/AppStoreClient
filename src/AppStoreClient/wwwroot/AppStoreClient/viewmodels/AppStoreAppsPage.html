<link rel="import" href="/sys/puppet-redirect/src/puppet-redirect.html">
<link rel="import" href="/sys/star-rating/star-rating.html">
<link rel="import" href="/AppStoreClient/elements/app-store-client-root.html" />
<link rel="stylesheet" href="/AppStoreClient/css/master.css">
<template>

    <style>
        .appstorebody {
            font-family: Verdana, Geneva, sans-serif;
            background: #B3B3B3;
        }

        .appstoreheader {
            -webkit-box-shadow: 0 0 2px rgba(0,0,0,.12),0 2px 4px rgba(0,0,0,.24);
            box-shadow: 0 0 2px rgba(0,0,0,.12),0 2px 4px rgba(0,0,0,.24);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 5px 5px 20px;
        }
    </style>

    <template id="appStoreView" bind>

        <div class="appstorebody">

            <template repeat="{{store in AppStoreStores}}">

                <div class="appstoreheader">
                    <h1>{{store.DisplayName}} Store</h1>
                </div>
                <div class="appStoreItemPanel">
                    <!--<template repeat="{{item in store.Applications | orderBy('DisplayName')}}">-->
                    <app-store-client-root applications="{{store.Applications}}"></app-store-client-root>
                </div>
            </template>

        </div>

    </template>

    <link is="puppet-redirect" history url="{{ RedirectUrl }}">

    <script>
        (function () {
            function bindAppStorePuppet(puppet) {
                var element = document.getElementById("appStoreView");
                element.model = puppet.obj;
                if (!element.bindingDelegate) {
                    element.bindingDelegate = new PolymerExpressions(); // Make the "item" bindings work
                }
            }
            if (!window.appStorePuppet) {
                var sessionPuppet = document.querySelector("puppet-client");
                var referer = sessionPuppet.network.referer;
                var result = referer.match(/^\/__([^/]*)/);
                var dbname = result[1];
                if (!dbname) {
                    throw new Error("Dbname could not be determined from URL " + referer);
                }
                var adminPort = 8181;
                var url = window.location.protocol + "//" + window.location.hostname + ":" + adminPort + "/api/servermodel/" + dbname;
                window.appStorePuppet = new Puppet({
                    remoteUrl: url,
                    localVersionPath: "",
                    remoteVersionPath: "",
                    useWebSocket: true,
                    callback: function () {
                        bindAppStorePuppet(this);
                        this.obj.RefreshAppStoreStores$++;
                    }
                });
            }
            else {
                bindAppStorePuppet(window.appStorePuppet);
            }
        })();
    </script>
</template>